<!DOCTYPE html>
<html><head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	
	
	<title>WSL setup for Windows 10 · N &amp; R</title>
	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	
	
	<link rel="stylesheet" href="/css/styles.min.f0612bbd3f2b017f7cdbd223e53797c96bf3dc6a2e0bc1d7f661de05ee7ce96a.css" integrity="sha256-8GErvT8rAX9829Ij5TeXyWvz3GouC8HX9mHeBe586Wo=">
</head>

<body class="dark:bg-gray-800 flex flex-col h-screen">
	<div class="flex flex-col h-screen">
		<header><nav class="m-0"><svg width="0" height="0" class="hidden">
	<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="twitter">
		<title>Twitter icon</title>
		<path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path>
	</symbol>
	<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="linkedin">
		<title>LinkedIn icon</title>
		<path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path>
	</symbol>
	<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="rss">
		<title>RSS icon</title>
		<path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415a3.3 3.3 0 013.293 3.295A3.303 3.303 0 013.283 24C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"></path>
	</symbol>
	<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="github">
		<title>GitHub icon</title>
		<path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
	</symbol>
	<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="youtube">
		<title>YouTube icon</title>
		<path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"></path>
	</symbol>
	<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="gitlab">
		<title>GitLab icon</title>
		<path d="M4.845.904c-.435 0-.82.28-.955.692C2.639 5.449 1.246 9.728.07 13.335a1.437 1.437 0 00.522 1.607l11.071 8.045c.2.145.472.144.67-.004l11.073-8.04a1.436 1.436 0 00.522-1.61c-1.285-3.942-2.683-8.256-3.817-11.746a1.004 1.004 0 00-.957-.684.987.987 0 00-.949.69L15.8 9.001H8.203l-2.41-7.408a.987.987 0 00-.942-.69h-.006zm-.006 1.42l2.173 6.678H2.675zm14.326 0l2.168 6.678h-4.341zm-10.593 7.81h6.862c-1.142 3.52-2.288 7.04-3.434 10.559L8.572 10.135zm-5.514.005h4.321l3.086 9.5zm13.567 0h4.325c-2.467 3.17-4.95 6.328-7.411 9.502 1.028-3.167 2.059-6.334 3.086-9.502zM2.1 10.762l6.977 8.947-7.817-5.682a.305.305 0 01-.112-.341zm19.798 0l.952 2.922a.305.305 0 01-.11.341v.002l-7.82 5.68.026-.035z"></path>
	</symbol>
	<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22" id="clock">
		<path d="M11,22A11,11,0,1,1,22,11,11,11,0,0,1,11,22ZM11,2a9,9,0,1,0,9,9A9,9,0,0,0,11,2Z"></path>
		<path d="M15,14a.93.93,0,0,1-.45-.11l-4-2A1,1,0,0,1,10,11V5a1,1,0,0,1,2,0v5.38l3.45,1.73a1,1,0,0,1,.44,1.34A1,1,0,0,1,15,14Z"></path>
</svg>
<div
class="
	h-14
	flex
	items-center
	grid grid-cols-2
	dark:bg-gray-700
	dark:text-gray-300
"
>
<div class="font-bold">
	<div class="inline-block p-2"><a href="https://www.numbersandreality.com/">N &amp; R</a></div>
	
	<div class="inline-block p-2">
	<a href="/about/">About</a>
	</div>
	
	<div class="inline-block p-2">
	<a href="/notes">Notes</a>
	</div>
	
	<div class="inline-block p-2">
	<a href="/posts">Posts</a>
	</div>
	
</div>

<div class="flex flex-row-reverse">


	<div class="p-2 fill-current text-gray-300">
	<a href="/index.xml">
		<svg width="20" height="20" role="img">
		<use xlink:href="#rss"></use>
		</svg>
	</a>
	</div>


	<div class="p-2 fill-current text-gray-300">
	<a href="https://twitter.com/_iranvir">
		<svg width="20" height="20" role="img">
		<use xlink:href="#twitter"></use>
		</svg>
	</a>
	</div>

	<div class="p-2 fill-current text-gray-300">
	<a href="https://gitlab.com/Ranvir">
		<svg width="20" height="20" role="img">
		<use xlink:href="#gitlab"></use>
		</svg>
	</a>
	</div>

	<div class="p-2 fill-current text-gray-300">
	<a href="https://www.linkedin.com/in/iranvir/">
		<svg width="20" height="20">
		<use xlink:href="#linkedin"></use>
		</svg>
	</a>
	</div>

	<div class="p-2 fill-current text-gray-300">
	<a href="https://youtube.com/c/iRanvir">
		<svg width="20" height="20" role="img">
		<use xlink:href="#youtube"></use>
		</svg>
	</a>
	</div>

</div>
</div>
</nav>
</header>
		<main class="flex-grow">
<div>
	<h1 class="p-4 dark:bg-gray-800 dark:text-gray-300">WSL setup for Windows 10</h1>
</div>

<div class="h-auto grid grid-cols-9 dark:bg-gray-800 dark:text-gray-300">
	<div
	class="
		sticky
		top-10
		rounded-md
		max-h-60
		overflow-auto
		overscroll-contain
		shadow-md
		dark:bg-gray-700
		m-4
		col-start-1 col-span-2
		p-4
		scrollbar scrollbar-track-gray-900 scrollbar-thumb-gray-600
	"
	>
	<h4><strong> Index </strong></h4><nav id="TableOfContents">
  <ul>
    <li><a href="#fetching-ssh-keys">Fetching SSH keys</a></li>
    <li><a href="#autolaunching-ssh-agent">Autolaunching SSH agent</a></li>
    <li><a href="#splitting-everything-into-files">Splitting everything into files</a></li>
    <li><a href="#installing-needed-apps">Installing needed apps</a></li>
    <li><a href="#thats-it">That&rsquo;s it</a></li>
  </ul>
</nav></div>
	<div class="w-text-justify auto col-start-3 col-span-5 p-4">
	<p>I like to use Windows 10 for gaming and other purposes. I like using Linux/BSDs
in the cloud, however they don&rsquo;t interoperate very well. Until such time comes
when I can buy a MacBook Pro (the only UNIX that works on Desktop) I have
decided to use WSL v1 on my Windows host for all of my Unix related workload.</p>
<p>WSL v1 allows me to use all of my CPU cores, works well with VS Code and does
90% of all I need from it. It is also less clunky compared to a full blown VM or
Docker on Windows (which, by the way, also uses VM).</p>
<p>As an added bonus, if I automate things properly. I can break things in the
userland as much as I want, and simply reset the app from Windows settings and I
am back with  a clean installation. This is an overview of what is being
automated and how. I am using the Debian 10 app from Microsoft Store and the
script is stored at this <a href="https://github.com/sranvir/wsl-setup">Git repo</a>.</p>
<h2 id="fetching-ssh-keys">Fetching SSH keys</h2>
<p>As stated previously, I use Unix in the cloud. To work with it I need
openssh-client: <code>apt install openssh-client</code> . The next step is to bring in my
SSH keys. My SSH keys are store in my Windows home folder in following
subdirectory <code>C:\User\Ranvir\.ssh</code>. It also contains a <code>config</code> file for SSH
aliases, etc.</p>
<p>The first order of business is to fetch the contents of this directory to my WSL
environment. Since, the Windows username is not the same for everyone, I am
taking the first argument to the below script as your Windows username:</p>
<pre><code>sh
WIN_USERNAME=$1

# Get SSH keys from Windows environment
# Need to make the below block more readable, basically it sets permissions for ssh-keys. 
umask 077
if [ ! -d ~/.ssh ]
then
    cp -r /mnt/c/Users/$WIN_USERNAME/.ssh ~/
    chmod 600 ~/.ssh/config
    chmod 400 ~/.ssh/id*
fi
</code></pre><p>I set the umask to 077 so that any directory/file created on the WSL end, by
this script, will have permissions. It is same as permission 700 using <code>chmod</code>,
i.e, only the user running the script will have read, write and execute
permission for all the files being created. Everyone else, except <code>root</code>, and
other won&rsquo;t have any permission whatsoever.</p>
<p>OpenSSH warns you if the permissions are too liberal. Next I set sane
permissions on config and id_* keys and that&rsquo;s that.</p>
<h2 id="autolaunching-ssh-agent">Autolaunching SSH agent</h2>
<p>If you start a process in WSL it will continue to run even when you close the
terminal. Go ahead and run the command <code>sleep 100</code> in your WSL terminal, list
the process using <code>ps</code>, note the PID and close the terminal. If you open the
terminal again and list the processes, you will find <code>sleep 100</code> still running
with the same PID.</p>
<p>However, if you create a variable in your bash environment, e.g VAR=1, that
won&rsquo;t persist the terminal being closed and then being started again.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ echo $VAR
<span style="color:#ae81ff">1</span>
<span style="color:#75715e">## Close and reopen your terminal</span>
$ echo $VAR

$
</code></pre></div><p>So processes persist, but environment variables don&rsquo;t.</p>
<p>So, in theory, if you just manual start <code>ssh-agent</code> and then and your keys using
<code>ssh-add</code> the process will not die, however, it also requires a couple of
environment variables, i.e, <code>SSH_AGENT_PID</code> and <code>SSH_AGENT_AUTH_SOCK</code> and these
need to persist as long as you are logged into your Windows host. So we store
these variables in <code>~/.ssh/agent.env</code> file and load it using <code>.profile</code>.</p>
<p>The below script autolaunches SSH agent if it detects that the agent is not
running, or running without a key and it also handles all the logic with
<code>agent.env</code>file. Of course, this is taken from <a href="https://help.github.com/en/github/authenticating-to-github/working-with-ssh-key-passphrases#auto-launching-ssh-agent-on-git-for-windows">GitHub help
page</a>,
where it was being used for the Git Bash utility on Windows, but it works quite
well on WSL as well.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">## SSH agent</span>
sshenv<span style="color:#f92672">=</span>~/.ssh/agent.env

agent_load_sshenv <span style="color:#f92672">()</span> <span style="color:#f92672">{</span> test -f <span style="color:#e6db74">&#34;</span>$sshenv<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&amp;&amp;</span> . <span style="color:#e6db74">&#34;</span>$sshenv<span style="color:#e6db74">&#34;</span> &gt;| /dev/null ; <span style="color:#f92672">}</span>

agent_start <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">(</span>umask 077; ssh-agent &gt;| <span style="color:#e6db74">&#34;</span>$sshenv<span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
    . <span style="color:#e6db74">&#34;</span>$sshenv<span style="color:#e6db74">&#34;</span> &gt;| /dev/null ; <span style="color:#f92672">}</span>

agent_load_sshenv

<span style="color:#75715e"># agent_run_state: 0=agent running w/ key; 1=agent w/o key; 2= agent not running</span>
agent_run_state<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ssh-add -l &gt;| /dev/null 2&gt;&amp;1; echo $?<span style="color:#66d9ef">)</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! <span style="color:#e6db74">&#34;</span>$SSH_AUTH_SOCK<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> $agent_run_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    agent_start
    ssh-add
<span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$SSH_AUTH_SOCK<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $agent_run_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    ssh-add
<span style="color:#66d9ef">fi</span>

unset sshenv
</code></pre></div><p>I get a few error codes now and again, when exiting a session, but I don&rsquo;t know
if its because of this script or the Windows Terminal which is still in preview
at the time of this writing.</p>
<h2 id="splitting-everything-into-files">Splitting everything into files</h2>
<p>When it comes to automation, organization is the name of the game. I don&rsquo;t have
much going on with my repo, still I have different bits of data split into
files. The SSH agent script mentioned above is its own file, so are the various
aliases.</p>
<p>Even though they all are going to be added to the same <code>~/.profile</code> file, it is
important to segregate them into discreet chunks. The main function, the
<code>wsl-setup.sh</code> script then puts them all together. The script itself is pretty
self explanatory so I won&rsquo;t go into details here.</p>
<p>But you can find <code>.gitconfig</code>, <code>.vimrc</code>, etc in the repository. Which are simply
copied from the repo into my home directory.</p>
<h2 id="installing-needed-apps">Installing needed apps</h2>
<p>I use Ansible for everyday use, so the script installs ansible, curl, git and a
few other packages that I might need.</p>
<h2 id="thats-it">That&rsquo;s it</h2>
<p>This simple repo, with way fewer lines that this long post, sets up everything I
need to be productive in a Unix-like userland.</p>

	</div>
</div>
</main>
		<footer class="grid grid-cols-2 dark:bg-gray-700 dark:text-gray-300"><div class="flex flex-row p-2">
	<p>
		<a href="https://www.numbersandreality.com/">
			N &amp; R &copy; 2020
		</a>
	</p>
</div>

<div class="flex flex-row-reverse p-2">
	<p>Made with ❤️ using <a href="https://gohugo.io">Hugo</a></p>
</div>
</footer>
	</div>
</body>
</html>
